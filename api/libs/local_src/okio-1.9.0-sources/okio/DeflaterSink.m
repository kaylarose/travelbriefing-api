//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: build/libs_raw/okio-1.9.0-sources/okio/DeflaterSink.java
//

#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "java/lang/IllegalArgumentException.h"
#include "java/lang/Math.h"
#include "java/util/zip/Deflater.h"
#include "okio/Buffer.h"
#include "okio/BufferedSink.h"
#include "okio/DeflaterSink.h"
#include "okio/Okio.h"
#include "okio/Segment.h"
#include "okio/SegmentPool.h"
#include "okio/Sink.h"
#include "okio/Timeout.h"
#include "okio/Util.h"

@interface OkioDeflaterSink () {
 @public
  id<OkioBufferedSink> sink_;
  JavaUtilZipDeflater *deflater_;
  jboolean closed_;
}

- (void)deflateWithBoolean:(jboolean)syncFlush;

@end

J2OBJC_FIELD_SETTER(OkioDeflaterSink, sink_, id<OkioBufferedSink>)
J2OBJC_FIELD_SETTER(OkioDeflaterSink, deflater_, JavaUtilZipDeflater *)

__attribute__((unused)) static void OkioDeflaterSink_deflateWithBoolean_(OkioDeflaterSink *self, jboolean syncFlush);

@implementation OkioDeflaterSink

- (instancetype)initWithOkioSink:(id<OkioSink>)sink
         withJavaUtilZipDeflater:(JavaUtilZipDeflater *)deflater {
  OkioDeflaterSink_initWithOkioSink_withJavaUtilZipDeflater_(self, sink, deflater);
  return self;
}

- (instancetype)initWithOkioBufferedSink:(id<OkioBufferedSink>)sink
                 withJavaUtilZipDeflater:(JavaUtilZipDeflater *)deflater {
  OkioDeflaterSink_initWithOkioBufferedSink_withJavaUtilZipDeflater_(self, sink, deflater);
  return self;
}

- (void)writeWithOkioBuffer:(OkioBuffer *)source
                   withLong:(jlong)byteCount {
  OkioUtil_checkOffsetAndCountWithLong_withLong_withLong_(((OkioBuffer *) nil_chk(source))->size_, 0, byteCount);
  while (byteCount > 0) {
    OkioSegment *head = source->head_;
    jint toDeflate = (jint) JavaLangMath_minWithLong_withLong_(byteCount, ((OkioSegment *) nil_chk(head))->limit_ - head->pos_);
    [((JavaUtilZipDeflater *) nil_chk(deflater_)) setInputWithByteArray:head->data_ withInt:head->pos_ withInt:toDeflate];
    OkioDeflaterSink_deflateWithBoolean_(self, false);
    source->size_ -= toDeflate;
    head->pos_ += toDeflate;
    if (head->pos_ == head->limit_) {
      source->head_ = [head pop];
      OkioSegmentPool_recycleWithOkioSegment_(head);
    }
    byteCount -= toDeflate;
  }
}

- (void)deflateWithBoolean:(jboolean)syncFlush {
  OkioDeflaterSink_deflateWithBoolean_(self, syncFlush);
}

- (void)flush {
  OkioDeflaterSink_deflateWithBoolean_(self, true);
  [((id<OkioBufferedSink>) nil_chk(sink_)) flush];
}

- (void)finishDeflate {
  [((JavaUtilZipDeflater *) nil_chk(deflater_)) finish];
  OkioDeflaterSink_deflateWithBoolean_(self, false);
}

- (void)close {
  if (closed_) return;
  NSException *thrown = nil;
  @try {
    [self finishDeflate];
  }
  @catch (NSException *e) {
    thrown = e;
  }
  @try {
    [((JavaUtilZipDeflater *) nil_chk(deflater_)) end];
  }
  @catch (NSException *e) {
    if (thrown == nil) thrown = e;
  }
  @try {
    [((id<OkioBufferedSink>) nil_chk(sink_)) close];
  }
  @catch (NSException *e) {
    if (thrown == nil) thrown = e;
  }
  closed_ = true;
  if (thrown != nil) OkioUtil_sneakyRethrowWithNSException_(thrown);
}

- (OkioTimeout *)timeout {
  return [((id<OkioBufferedSink>) nil_chk(sink_)) timeout];
}

- (NSString *)description {
  return JreStrcat("$@C", @"DeflaterSink(", sink_, ')');
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithOkioSink:withJavaUtilZipDeflater:", NULL, 0x1, -1, 0, -1, -1, -1, -1 },
    { "initWithOkioBufferedSink:withJavaUtilZipDeflater:", NULL, 0x0, -1, 1, -1, -1, -1, -1 },
    { "writeWithOkioBuffer:withLong:", "V", 0x1, 2, 3, 4, -1, -1, -1 },
    { "deflateWithBoolean:", "V", 0x2, 5, 6, 4, -1, -1, -1 },
    { "flush", "V", 0x1, -1, -1, 4, -1, -1, -1 },
    { "finishDeflate", "V", 0x0, -1, -1, 4, -1, -1, -1 },
    { "close", "V", 0x1, -1, -1, 4, -1, -1, -1 },
    { "timeout", "LOkioTimeout;", 0x1, -1, -1, -1, -1, -1, -1 },
    { "description", "LNSString;", 0x1, 7, -1, -1, -1, -1, -1 },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "sink_", "LOkioBufferedSink;", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "deflater_", "LJavaUtilZipDeflater;", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "closed_", "Z", .constantValue.asLong = 0, 0x2, -1, -1, -1, -1 },
  };
  static const void *ptrTable[] = { "LOkioSink;LJavaUtilZipDeflater;", "LOkioBufferedSink;LJavaUtilZipDeflater;", "write", "LOkioBuffer;J", "LJavaIoIOException;", "deflate", "Z", "toString" };
  static const J2ObjcClassInfo _OkioDeflaterSink = { "DeflaterSink", "okio", ptrTable, methods, fields, 7, 0x11, 9, 3, -1, -1, -1, -1, -1 };
  return &_OkioDeflaterSink;
}

@end

void OkioDeflaterSink_initWithOkioSink_withJavaUtilZipDeflater_(OkioDeflaterSink *self, id<OkioSink> sink, JavaUtilZipDeflater *deflater) {
  OkioDeflaterSink_initWithOkioBufferedSink_withJavaUtilZipDeflater_(self, OkioOkio_bufferWithOkioSink_(sink), deflater);
}

OkioDeflaterSink *new_OkioDeflaterSink_initWithOkioSink_withJavaUtilZipDeflater_(id<OkioSink> sink, JavaUtilZipDeflater *deflater) {
  J2OBJC_NEW_IMPL(OkioDeflaterSink, initWithOkioSink_withJavaUtilZipDeflater_, sink, deflater)
}

OkioDeflaterSink *create_OkioDeflaterSink_initWithOkioSink_withJavaUtilZipDeflater_(id<OkioSink> sink, JavaUtilZipDeflater *deflater) {
  J2OBJC_CREATE_IMPL(OkioDeflaterSink, initWithOkioSink_withJavaUtilZipDeflater_, sink, deflater)
}

void OkioDeflaterSink_initWithOkioBufferedSink_withJavaUtilZipDeflater_(OkioDeflaterSink *self, id<OkioBufferedSink> sink, JavaUtilZipDeflater *deflater) {
  NSObject_init(self);
  if (sink == nil) @throw new_JavaLangIllegalArgumentException_initWithNSString_(@"source == null");
  if (deflater == nil) @throw new_JavaLangIllegalArgumentException_initWithNSString_(@"inflater == null");
  self->sink_ = sink;
  self->deflater_ = deflater;
}

OkioDeflaterSink *new_OkioDeflaterSink_initWithOkioBufferedSink_withJavaUtilZipDeflater_(id<OkioBufferedSink> sink, JavaUtilZipDeflater *deflater) {
  J2OBJC_NEW_IMPL(OkioDeflaterSink, initWithOkioBufferedSink_withJavaUtilZipDeflater_, sink, deflater)
}

OkioDeflaterSink *create_OkioDeflaterSink_initWithOkioBufferedSink_withJavaUtilZipDeflater_(id<OkioBufferedSink> sink, JavaUtilZipDeflater *deflater) {
  J2OBJC_CREATE_IMPL(OkioDeflaterSink, initWithOkioBufferedSink_withJavaUtilZipDeflater_, sink, deflater)
}

void OkioDeflaterSink_deflateWithBoolean_(OkioDeflaterSink *self, jboolean syncFlush) {
  OkioBuffer *buffer = [((id<OkioBufferedSink>) nil_chk(self->sink_)) buffer];
  while (true) {
    OkioSegment *s = [((OkioBuffer *) nil_chk(buffer)) writableSegmentWithInt:1];
    jint deflated = syncFlush ? [((JavaUtilZipDeflater *) nil_chk(self->deflater_)) deflateWithByteArray:((OkioSegment *) nil_chk(s))->data_ withInt:s->limit_ withInt:OkioSegment_SIZE - s->limit_ withInt:JavaUtilZipDeflater_SYNC_FLUSH] : [((JavaUtilZipDeflater *) nil_chk(self->deflater_)) deflateWithByteArray:((OkioSegment *) nil_chk(s))->data_ withInt:s->limit_ withInt:OkioSegment_SIZE - s->limit_];
    if (deflated > 0) {
      s->limit_ += deflated;
      buffer->size_ += deflated;
      (void) [self->sink_ emitCompleteSegments];
    }
    else if ([self->deflater_ needsInput]) {
      if (s->pos_ == s->limit_) {
        buffer->head_ = [s pop];
        OkioSegmentPool_recycleWithOkioSegment_(s);
      }
      return;
    }
  }
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OkioDeflaterSink)
